# -*- Tcl -*-

package require tcltest 2.2
namespace import -force ::tcltest::*

::tcltest::configure {*}$argv

if {[ns_config test listenport]} {
    testConstraint serverListen true
}

test ns_listencallback-1.0 {register} -constraints {serverListen} -setup {
    #
    # search for a free port
    #
    set localhost [expr {[ns_info ipv6] ? "::1" : "127.0.0.1"}]
    for {set port 7225} {$port < 9225} {incr port} {
        ns_log notice "try $localhost $port"
        if {![catch {
            ns_log notice "could open $addr $port"
            close [ns_socklisten $localhost $port]
        } errorMsg]} {
            ns_log notice "try $addr $port failed -> $errorMsg"
            continue
        } else {
            break
        }
    }
    #
    # Register listen callback with Tcl handler
    #
    ns_socklistencallback * $port ns_listencallback::conn_handler
} -body {

    ns_log notice "open socket on $localhost $port"
    set fds [ns_sockopen $localhost $port]
    lassign $fds rfd wfd
    set size 0

    if {[gets $rfd line] == -1} {
        ns_log error "got no data"
    } else {
        incr size [string length $line]
        puts $wfd "How are you?"
        flush $wfd
        gets $rfd line
        incr size [string length $line]
    }
    return [list size $size]
} -cleanup {
    #
    # Currently, there seems to way to stop listening on that port.
    #
    unset -nocomplain port localhost
} -result {size 46}

#
# the following function must be available in the blueprint
#
if {0} {
    proc ns_listencallback::conn_handler {rfd wfd} {
        puts  $wfd "Welcome to the test server"
        flush $wfd
        gets  $rfd line
        puts  $wfd "Well isn't that nice"
        flush $wfd
    }
}


# Local variables:
#    mode: tcl
#    tcl-indent-level: 4
#    indent-tabs-mode: nil
# End:
