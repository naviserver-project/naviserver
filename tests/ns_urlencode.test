# -*- Tcl -*-

package require tcltest 2.2
namespace import -force ::tcltest::*

::tcltest::configure {*}$argv


# rfc2396 unreserved URI characters, except for + which receives
# special treatment by the HTTP URL scheme.
set unreservedChars "-.!~*'()0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"

test ns_urlencode-1.1.1 {basic syntax} -body {
    ns_urlencode
} -returnCodes error -result {wrong # args: should be "ns_urlencode ?-charset charset? ?-part part? ?-uppercase? ?--? args"}

test ns_urlencode-1.1.2 {basic syntax} -body {
    ns_urlencode -part x y
} -returnCodes error -result {bad option "x": must be query, path, or cookie}

test ns_urlencode-1.2.1 {basic syntax} -body {
    ns_urldecode
} -returnCodes error -result {wrong # args: should be "ns_urldecode ?-charset charset? ?-part part? ?--? string"}

test ns_urlencode-1.2.2 {basic syntax} -body {
    ns_urldecode -part x y
} -returnCodes error -result {bad option "x": must be query, path, or cookie}


test ns_urlencode-2.1.1a {basic operation} -body {
    ns_urlencode ""
} -result {}

test ns_urlencode-2.1.1b {basic operation} -body {
    ns_urlencode --
} -returnCodes error -result {wrong # args: should be "ns_urlencode ?-charset charset? ?-part part? ?-uppercase? ?--? args"}

test ns_urlencode-2.1.1c {basic operation} -body {
    ns_urlencode -- --
} -result {--}

test ns_urlencode-2.1.1d {basic operation} -body {
    ns_urldecode --
} -returnCodes error -result {wrong # args: should be "ns_urldecode ?-charset charset? ?-part part? ?--? string"}

test ns_urlencode-2.1.1e {basic operation} -body {
    ns_urldecode -- --
} -result {--}

test ns_urlencode-2.1.2 {basic operation} -body {
    ns_urlencode -part path ""
} -result {}

test ns_urlencode-2.1.3 {basic operation} -body {
    ns_urlencode -part query ""
} -result {}

test ns_urlencode-2.2.1 {basic operation} -body {
    ns_urldecode ""
} -result {}

test ns_urlencode-2.2.2 {basic operation} -body {
    ns_urldecode -part path ""
} -result {}

test ns_urlencode-2.2.3 {basic operation} -body {
    ns_urldecode -part query ""
} -result {}

test ns_urlencode-2.2.4 {basic operation} -body {
    ns_urldecode "1"
} -result {1}

test ns_urlencode-2.2.5 {basic operation} -body {
    ns_urldecode -part path "1"
} -result {1}

test ns_urlencode-2.2.6 {basic operation} -body {
    ns_urldecode -part query "1"
} -result {1}



test ns_urlencode-2.3.1 {unreserved characters} -body {
    ns_urlencode $unreservedChars
} -result $unreservedChars

test ns_urlencode-2.3.2 {unreserved characters} -body {
    ns_urldecode $unreservedChars
} -result $unreservedChars


test ns_urlencode-2.4.1 {multiple args} -body {
    ns_urlencode -part path 1 2 3
} -result {1/2/3}

test ns_urlencode-2.4.2 {multiple args} -body {
    ns_urlencode -part query 1 2 3
} -result {1&2&3}

test ns_urlencode-2.4.3 {multiple args} -body {
    ns_urlencode 1 2 3
} -result {1&2&3}


test ns_urlencode-2.5.1 {spaces and plus signs} -body {
    ns_urlencode -part path +
} -result {+}

test ns_urlencode-2.5.2 {spaces and plus signs} -body {
    ns_urlencode -part query +
} -result {%2b}

test ns_urlencode-2.5.3 {spaces and plus signs} -body {
    ns_urlencode +
} -result {%2b}

test ns_urlencode-2.5.4 {spaces and plus signs} -body {
    ns_urlencode -part path " "
} -result {%20}

test ns_urlencode-2.5.5 {spaces and plus signs} -body {
    ns_urlencode -part query " "
} -result {+}

test ns_urlencode-2.5.6 {spaces and plus signs} -body {
    ns_urlencode " "
} -result {+}

test ns_urlencode-2.5.7 {spaces and plus signs} -body {
    ns_urldecode -part path +
} -result {+}

test ns_urlencode-2.5.8 {spaces and plus signs} -body {
    ns_urldecode -part query +
} -result { }

test ns_urlencode-2.5.9 {spaces and plus signs} -body {
    ns_urldecode +
} -result { }

test ns_urlencode-2.5.10 {spaces and plus signs} -body {
    ns_urldecode -part path " "
} -result { }

test ns_urlencode-2.5.11 {spaces and plus signs} -body {
    ns_urldecode -part query " "
} -result { }

test ns_urlencode-2.5.12 {spaces and plus signs} -body {
    ns_urldecode " "
} -result { }

test ns_urlencode-2.5.10 {spaces and plus signs} -body {
    ns_urldecode -part path "%20"
} -result { }

test ns_urlencode-2.5.11 {spaces and plus signs} -body {
    ns_urldecode -part query "%20"
} -result { }

test ns_urlencode-2.5.12 {spaces and plus signs} -body {
    ns_urldecode "%20"
} -result { }

test ns_urlencode-2.5.13 {spaces and plus signs} -body {
    ns_urldecode -part path "%2b"
} -result {+}

test ns_urlencode-2.5.14 {spaces and plus signs} -body {
    ns_urldecode -part query "%2b"
} -result {+}

test ns_urlencode-2.5.15 {spaces and plus signs} -body {
    ns_urldecode "%2b"
} -result {+}

test ns_urlencode-2.5.16 {spaces and plus signs} -body {
    ns_urldecode "%2B"
} -result {+}


test ns_urlencode-2.6.1 {rfc2396 section 2.4.3 URI 'delim' characters} -body {
    ns_urlencode -part path "<>\#%\""
} -result {%3c%3e%23%25%22}


test ns_urlencode-2.7.1 {rfc2396 section 2.4.3 URI 'unwise' characters} -body {
    ns_urlencode -part path {{}|\^[]`}
} -result {%7b%7d%7c%5c%5e%5b%5d%60}


test ns_urlencode-2.8.1 {rfc2396 section 3.3 URI path component reserved characters} -body {
    ns_urlencode -part path {/?;=}
} -result {%2f%3f%3b%3d}

test ns_urlencode-2.8.2 {path component unreserved characters} -body {
    ns_urlencode -part path {:@&+$,}
} -result {:@&+$,}


test ns_urlencode-2.9.1 {rfc2396 section 3.4 URI query component reserved characters} -body {
    ns_urlencode -part query {;/?:@&=+,$}
} -result {%3b/?:@%26%3d%2b%2c$}

test ns_urlencode-2.10.1 {charset decode} -body {
    ns_urldecode -charset iso8859-1 "%FA"
} -result {ú}
test ns_urlencode-2.10.2 {charset encode} -body {
    ns_urlencode -charset iso8859-1 "ú"
} -result {%fa}


if {[ns_config test listenport] ne ""} {
    testConstraint serverListen true
}

test ns_urlencode-3.0 {test request with unencoded path segments} -constraints {serverListen} -setup {
    ns_register_proc GET /foo/* {
        ns_return 200 text/plain [list [ns_conn url] [ns_conn urlv]]
    }
} -body {
    nstest::http -http 1.1 -getbody 1 GET /foo/bar.tcl
} -cleanup {
    ns_unregister_op GET /foo/*
} -result "200 {/foo/bar.tcl {foo bar.tcl}}"

test ns_urlencode-3.1 {test request with unencoded path segments, 2 elements, ending with slash} -constraints {serverListen} -setup {
    ns_register_proc GET /foo/* {
        ns_return 200 text/plain [list [ns_conn url] [ns_conn urlv]]
    }
} -body {
    nstest::http -http 1.1 -getbody 1 GET /foo/bar/
} -cleanup {
    ns_unregister_op GET /foo/*
} -result "200 {/foo/bar/ {foo bar}}"

test ns_urlencode-3.2 {test request with unencoded path segments, 1 element ending with slash} -constraints {serverListen} -setup {
    ns_register_proc GET /foo* {
        ns_return 200 text/plain [list [ns_conn url] [ns_conn urlv]]
    }
} -body {
    nstest::http -http 1.1 -getbody 1 GET /foo/
} -cleanup {
    ns_unregister_op GET /foo*
} -result "200 {/foo/ foo}"

test ns_urlencode-3.3 {test request with unencoded path segments, 1 element, no slash} -constraints {serverListen} -setup {
    ns_register_proc GET /foo* {
        ns_return 200 text/plain [list [ns_conn url] [ns_conn urlv]]
    }
} -body {
    nstest::http -http 1.1 -getbody 1 GET /foo
} -cleanup {
    ns_unregister_op GET /foo*
} -result "200 {/foo foo}"


test ns_urlencode-4.0 {test request with encoded path segments} -constraints {serverListen} -setup {
    ns_register_proc GET /foo/* {
        ns_return 200 text/plain [list [ns_conn url] [ns_conn urlv]]
    }
} -body {
    nstest::http -http 1.1 -getbody 1 GET /foo/bar%20baz.tcl
} -cleanup {
    ns_unregister_op GET /foo/*
} -result "200 {{/foo/bar baz.tcl} {foo {bar baz.tcl}}}"

test ns_urlencode-4.1 {test request with encoded path segments} -constraints {serverListen} -setup {
    ns_register_proc GET /foo/* {
        ns_return 200 text/plain [list [ns_conn url] [ns_conn urlv]]
    }
} -body {
    nstest::http -http 1.1 -getbody 1 GET /foo/bar%2fbaz.tcl
} -cleanup {
    ns_unregister_op GET /foo/*
} -result "200 {/foo/bar/baz.tcl {foo bar/baz.tcl}}"



test ns_urlencode-5.0 {encode and unencode character sequence with percent codes - path segment} -constraints {serverListen} -setup {
    ns_register_proc GET /encode-decode {
	set s "/%20,'\".=+"
	set sEnc [ns_urlencode -part path $s]
        ns_return 200 text/plain [list $s $sEnc [expr {[ns_urldecode -part path $sEnc] eq $s}]]
    }
} -body {
    nstest::http -http 1.1 -getbody 1 GET /encode-decode
} -cleanup {
    ns_unregister_op GET /encode-decode
} -result "200 {/%20,'\\\".=+ %2f%2520,'%22.%3d+ 1}"

test ns_urlencode-5.1 {encode and unencode character sequence with percent codes - query segment} -constraints {serverListen} -setup {
    ns_register_proc GET /encode-decode {
	set s "/%20,'\".=+"
	set sEnc [ns_urlencode -part query $s]
        ns_return 200 text/plain [list $s $sEnc [expr {[ns_urldecode -part query $sEnc] eq $s}]]
    }
} -body {
    nstest::http -http 1.1 -getbody 1 GET /encode-decode
} -cleanup {
    ns_unregister_op GET /encode-decode
} -result "200 {/%20,'\\\".=+ /%2520%2c'%22.%3d%2b 1}"

test ns_urlencode-5.2 {encode and unencode character sequence with percent codes - cookie} -constraints {serverListen} -setup {
    ns_register_proc GET /encode-decode {
	set s "/%20,'\".=+"
	set sEnc [ns_urlencode -part cookie $s]
        ns_return 200 text/plain [list $s $sEnc [expr {[ns_urldecode -part cookie $sEnc] eq $s}]]
    }
} -body {
    nstest::http -http 1.1 -getbody 1 GET /encode-decode
} -cleanup {
    ns_unregister_op GET /encode-decode
} -result "200 {/%20,'\\\".=+ /%2520%2c'%22.=+ 1}"

unset unreservedChars



cleanupTests
