# Emacs mode:  -*-Makefile-*-

# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.
#
# The Initial Developer of the Original Code and related documentation
# is America Online, Inc. Portions created by AOL are Copyright (C) 1999
# America Online, Inc. All Rights Reserved.
#
#

#
# Makefile.global.in --
#
#     Common and platform-specific make variables to be included
#     by other makefiles.
#

NAVISERVER       = @NAVISERVER@
srcdir           = @SRCDIR@

CPPCHECK         = cppcheck

NS_PATCH_LEVEL   = @NS_PATCH_LEVEL@

@SET_MAKE@

# Toggle verbosity: make VERBOSE=1 shows full commands
ifndef VERBOSE
  Q := @
  E := @echo
else
  Q :=
  E := @true
endif

# Pattern rule: shows short progress, runs real compile
%.o: %.c
	$(E) "  $(CC)  $<"
	$(Q)$(CC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

#
# The following binaries are assumed to live in the /bin/ directory,
# as specified by FHS 3.0 (Filesystem Hierarchy Standard).
# https://refspecs.linuxfoundation.org/FHS_3.0/fhs/ch03s04.html
#
# These locations have severed us well over the last 20+ years on a
# large variety of unix like systems. The paths are used for security
# reasons:
# - prevent command spoofing
# - reduce ambiguity
# - improves reliabilty (not depend on PATH settings)
# The reason for using variables is to provide a single place of
# definition, and the ability to override this also from the command
# line.
#
# Maybe, we should consider in the future some autoconf magic, when
# necessary.
#
RM               = /bin/rm -Rf
MKDIR            = /bin/mkdir -p
CP               = /bin/cp -pR
LN               = /bin/ln
MV               = /bin/mv
CAT              = /bin/cat
CHMOD            = /bin/chmod
CHOWN            = /bin/chown
OPENSSL          = openssl

ifdef NSBUILD
    INSTALL_SH	 = $(srcdir)/install-sh -c
else
    INSTALL_SH	 = $(INSTBIN)/install-sh -c
endif
INSTALL_DATA	 = $(INSTALL_SH) -m 644

RANLIB           = @RANLIB@
LIBEXT           = @SHLIB_SUFFIX@
EXEEXT           = @EXEEXT@
TCL_EXEC_PREFIX  = @TCL_EXEC_PREFIX@
TCLSH_PROG	 = @TCLSH_PROG@
LIB_RUNTIME_DIR  =
LDLIB            = @LDLIB@
LDSO             = @LDSO@
CCRFLAG          = @CCRFLAG@
LDRFLAG          = @LDRFLAG@
CCRPATH         += @CCRPATH@
LDRPATH         += @LDRPATH@
CC               = $(PURIFY) @CC@
CCLD             = @CCLD@

# Detect compiler kind (mutually exclusive)
CC_VERSION := $(shell $(CC) --version 2>/dev/null | head -1)
IS_CLANG   := $(shell echo '$(CC_VERSION)' | grep -i -c clang)
IS_GCC     := $(shell echo '$(CC_VERSION)' | grep -i -c gcc)
GCC_VER    := $(shell $(CC) -dumpfullversion -dumpversion 2>/dev/null)
GCC_MAJOR  := $(word 1,$(subst ., ,$(GCC_VER)))
lt         = $(shell [ $(1) -lt $(2) ] && echo 1 || echo 0)

# Defaults (empty; filled only for "new enough" compilers)
CFLAGS_CONVERSION_DEFAULT :=
CFLAGS_FORMAT_DEFAULT     :=
CFLAGS_DEFINITION_DEFAULT :=
CFLAGS_TIDY_DEFAULT       :=

ifeq ($(IS_GCC),1)

  # GCC > 6 (i.e. >= 7): enable extensive checks
  ifeq ($(call lt,$(GCC_MAJOR),7),0)
    CFLAGS_CONVERSION_DEFAULT = -Wconversion -Wsign-conversion -Wbad-function-cast -Wcast-align
    CFLAGS_FORMAT_DEFAULT     = -Wmissing-format-attribute -Wformat-security -Wformat=2
    CFLAGS_DEFINITION_DEFAULT = -Wwrite-strings -Wdeclaration-after-statement -Wmissing-prototypes -Wmissing-declarations
    CFLAGS_TIDY_DEFAULT       = -Wno-missing-braces -Wundef -Wunreachable-code \
                                -Wswitch-enum -Wold-style-definition \
                                -Wnull-dereference -Wdouble-promotion -Wvla $(CFLAGS_FORMAT_DEFAULT)
  endif

else ifeq ($(IS_CLANG),1)

  # Only compute CLANG_MAJOR for clang
  CLANG_MAJOR := $(shell echo '$(CC_VERSION)' | \
    sed -n 's/.*clang-\([0-9][0-9]*\)\..*/\1/p; \
            s/.*LLVM version \([0-9][0-9]*\)\..*/\1/p; \
            s/.*clang version \([0-9][0-9]*\)\..*/\1/p')

  # Clang > 13 (i.e. >= 14): enable extensive checks
  ifneq ($(CLANG_MAJOR),)
    ifeq ($(call lt,$(CLANG_MAJOR),14),0)
      CFLAGS_CONVERSION_DEFAULT = -Wconversion -Wsign-conversion -Wbad-function-cast -Wcast-align
      CFLAGS_FORMAT_DEFAULT     = -Wmissing-format-attribute -Wformat-security -Wformat=2
      CFLAGS_DEFINITION_DEFAULT = -Wwrite-strings -Wdeclaration-after-statement -Wmissing-prototypes -Wmissing-declarations
      CFLAGS_TIDY_DEFAULT       = -Wno-missing-braces -Wundef -Wunreachable-code \
                                  -Wswitch-enum -Wold-style-definition \
                                  -Wnull-dereference -Wdouble-promotion -Wvla $(CFLAGS_FORMAT_DEFAULT)
    endif
  endif

endif

# Allow user override; otherwise use computed defaults
CFLAGS_CONVERSION ?= $(CFLAGS_CONVERSION_DEFAULT)
CFLAGS_FORMAT     ?= $(CFLAGS_FORMAT_DEFAULT)
CFLAGS_DEFINITION ?= $(CFLAGS_DEFINITION_DEFAULT)
CFLAGS_TIDY       ?= $(CFLAGS_TIDY_DEFAULT)

#CFLAGS_FORTIFY    = -D_FORTIFY_SOURCE=2 -fstack-protector $(SANITIZE)
#CFLAGS_FORTIFY    = -fstack-protector $(SANITIZE) -fwrapv -ftrapv
CFLAGS_WARNING   = @CFLAGS_WARNING@
CFLAGS_WARNING   = @CFLAGS_WARNING@ -pedantic -Wextra $(CFLAGS_CONVERSION) $(CFLAGS_DEFINITION) $(CFLAGS_TIDY) $(CFLAGS_FORTIFY)

#CFLAGS_DEBUG     = @CFLAGS_DEBUG@ -DNDEBUG
CFLAGS_DEBUG     = @CFLAGS_DEBUG@
CFLAGS_OPTIMIZE  = @CFLAGS_OPTIMIZE@
CFLAGS_INCLUDE   = -I$(INCDIR) @TCL_INCLUDES@
#CFLAGS_EXTRA     = @SHLIB_CFLAGS@ @TCL_EXTRA_CFLAGS@ -DSYSTEM_MALLOC -std=c99 -DNS_NO_DEPRECATED -DTCL_NO_DEPRECATED
CFLAGS_EXTRA     = @SHLIB_CFLAGS@ @TCL_EXTRA_CFLAGS@ -DSYSTEM_MALLOC -std=c99
DEFS             = @DEFS@
#CFLAGS_DEFAULT    = @CFLAGS_DEFAULT@

# Detect compiler kind (mutually exclusive) and avoid = overwrites
CC_VERSION := $(shell $(CC) --version 2>/dev/null | head -1)

IS_CLANG  := $(shell echo '$(CC_VERSION)' | grep -i -c clang)
IS_GCC    := $(shell echo '$(CC_VERSION)' | grep -i -c gcc)
GCC_VER   := $(shell $(CC) -dumpfullversion -dumpversion 2>/dev/null)
GCC_MAJOR := $(word 1,$(subst ., ,$(GCC_VER)))

# Helper: add flag only if the compiler accepts it
# Usage: $(call cc-supports,<flag>)
cc-supports = $(shell \
  printf 'int main(void){return 0;}\n' | \
  $(CC) $(1) -Werror -x c - -c -o /dev/null >/dev/null 2>&1 && \
  echo "$(1)")

CFLAGS_COMPILER :=

# GCC extras (probe each)
ifeq ($(IS_GCC),1)
  # Always safe (pre-checked)
  CFLAGS_COMPILER += -Wlogical-op -Wclobbered -Wtrampolines

  # Known supported from GCC 7 upwards
  ifeq ($(call ge,$(GCC_MAJOR),7),1)
    CFLAGS_COMPILER += \
      -Wduplicated-cond -Wduplicated-branches -Wformat-overflow=2 \
      -Wformat-truncation=2 -Wrestrict -Wimplicit-fallthrough=3
  endif

  # Probe uncertain ones
  ifeq ($(call ge,$(GCC_MAJOR),8),1)
    CFLAGS_COMPILER += $(call cc-supports,-Wstringop-truncation)
  endif
  ifeq ($(call ge,$(GCC_MAJOR),11),1)
    CFLAGS_COMPILER += $(call cc-supports,-Wstringop-overread)
  endif
endif

# Clang extras (probe each)
ifeq ($(IS_CLANG),1)
CFLAGS_COMPILER += \
  $(call cc-supports,-Wshorten-64-to-32) \
  $(call cc-supports,-Wcomma) \
  $(call cc-supports,-Wnewline-eof)
endif

CFLAGS          += $(CFLAGS_DEFAULT) $(CFLAGS_DEBUG) $(CFLAGS_OPTIMIZE) $(CFLAGS_WARNING) $(CFLAGS_COMPILER) $(CFLAGS_EXTRA) $(CFLAGS_INCLUDE) $(PTHREAD_CFLAGS) @CPPFLAGS@ $(DEFS)
LDFLAGS         += $(CFLAGS_OPTIMIZE) $(SANITIZE)
LIBS		 = @LIBS@
DL_LIBS		 =
MATH_LIBS	 = @MATH_LIBS@
OPENSSL_LIBS     = @OPENSSL_LIBS@

# The Windows and Unix build systems treat $(LIBNM) differently, so we
# arrange things so that the final output of library names is the same
# on both platforms.  For nsd on Windows, we must use LIBNM = libnsd.
# (See also the comments in nsd/Makefile.)  Unix must instead use
# LIBNM = nsd here, and the lib prefix gets added elsewhere.  Since
# this file is Unix-only, we need this simple fix-up:

ifeq (libnsd,$(LIBNM))
  LIBNM := nsd
endif

ifndef NSBUILD
    LDFLAGS += -L$(NAVISERVER)/lib
    NSLIBS  += -lnsthread -lnsd
    INCDIR   = $(NAVISERVER)/include
    CFLAGS  += @ZLIB_INCLUDES@ @OPENSSL_INCLUDES@
else
    LDFLAGS += -L../nsthread -L../nsd -L../nsdb
    INCDIR   = ../include
    CFLAGS  += @OPENSSL_INCLUDES@
	ifeq (nsd,$(LIBNM))
		CFLAGS += @ZLIB_INCLUDES@
		NSLIBS += @ZLIB_LIBS@ @CRYPT_LIBS@
	endif
    ifneq (nsthread,$(LIBNM))
        NSLIBS += -lnsthread
        ifneq (nsd,$(LIBNM))
            ifneq (nsthreadtest,$(PGM))
                ifeq (nsdbtest,$(MODNAME))
                    NSLIBS += -lnsd -lnsdb
                else
                    NSLIBS += -lnsd
                endif
            endif
        endif
    endif
endif

#
# Add the OpenSSL libraries to the end to minimize interference of
# load paths for other libraries
#
NSLIBS      += @TCL_LIB_SPEC@ @LDFLAGS@ ${OPENSSL_LIBS} ${PTHREAD_LIBS}
CCLIBS       = $(NSLIBS)

# Install directories
INSTBIN      = $(NAVISERVER)/bin
INSTLIB      = $(NAVISERVER)/lib
INSTHDR      = $(NAVISERVER)/include
INSTMOD      = $(NAVISERVER)/modules
INSTTCL      = $(NAVISERVER)/tcl
INSTSRV      = $(NAVISERVER)/
INSTSRVMOD   = $(INSTSRV)/modules
INSTSRVPAG   = $(INSTSRV)/pages

# Platform-specific options.
uname = $(shell uname -a)

#
# Solaris, OpenSolaris
#
ifneq (,$(findstring SunOS,$(uname)))

    # Solaris 2.6+
    ifneq (,$(findstring 5.6,$(uname)))
        NSLIBS += -lthread -lposix4
    else
        NSLIBS += -lrt
    endif

    # OpenSolaris (e.g. OmniOS)
    ifneq (,$(findstring 5.11,$(uname)))
        NSLIBS += -lsendfile
    endif
endif

#
# For static linking on Darwin, link modules
# against server image.
#

ifneq (,$(findstring Darwin,$(uname)))
    ifeq ($(STATIC_BUILD), 1)
        ifdef NSBUILD
            LDSO += -bundle_loader $(srcdir)/nsd/nsd
        else
            LDSO += -bundle_loader $(NAVISERVER)/bin/nsd
        endif
    endif
endif

#
# FreeBSD, OpenBSD and NetBSD need the POSIX thread library and the math
# library to resolve functions such as lround()
#
# NetBSD needs -lpthread instead of -lthr, but also -lm.
#
ifneq (,$(findstring FreeBSD,$(uname)))
    NSLIBS += -lthr -lm
endif

ifneq (,$(findstring OpenBSD,$(uname)))
    NSLIBS += -lpthread -lm
endif

ifneq (,$(findstring NetBSD,$(uname)))
    NSLIBS += -lpthread -lm
endif

#
# MINGW needs additional system libraries
#
ifeq (.exe,$(EXEEXT))
    NSLIBS += -static-libgcc -Wl,-Bstatic -lpthread -lws2_32 -lcrypt32
endif
